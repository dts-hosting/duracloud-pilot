# DuraCloud - Technical Documentation

## Overview

DuraCloud is a set of serverless components built using AWS services centered
around digital preservation uses cases. It provides configuration and features
on top of AWS S3 to support long term access to and preservation of files.

## Architecture

The application is built using a serverless architecture on AWS with the following key components:

- **Lambda Functions**: Handle various events like file uploads, deletions, checksum verification, exports, and reporting
- **S3 Buckets**: Store files and provide event notifications
- **DynamoDB Tables**: Store file checksums and schedule verification tasks
- **SQS Queues**: Buffer events for processing
- **EventBridge**: Route events between services and schedule periodic tasks
- **CloudWatch**: Monitor and alert on system health

## Core Components

- bucket-requested
- file-uploaded
- file-deleted
- checksum-verification
- checksum-failure
- checksum-exporter
- checksum-export-csv-report
- inventory-unwrap
- report-generator

### Bucket Requested Function (`bucket-requested`)

- **Trigger**: S3 event when a file is uploaded to the bucket-requested bucket
- **Purpose**: Creates and configures S3 buckets based on requests
- **Key Features**:
  - Creates main bucket with versioning, lifecycle policies, and EventBridge notifications
  - Creates replication bucket for backup (same region)
  - Configures same-region replication with IAM role
  - Applies appropriate tags and policies based on bucket type
  - Handles special cases for public buckets with public access policies
  - Enables inventory configuration for storage analytics
  - Enables access logging for audit purposes
  - Implements rollback functionality if any step fails
  - Processes multiple bucket requests concurrently (up to 5 per request)

### File Uploaded Function (`file-uploaded`)

- **Trigger**: SQS message from EventBridge when an object is created in an S3 bucket
- **Purpose**: Calculates and stores checksums for uploaded files
- **Key Features**:
  - Calculates MD5 checksums for uploaded files
  - Compares checksums with S3 ETags for validation
  - Stores checksums and metadata in DynamoDB
  - Schedules future verification tasks via TTL
  - Handles batch processing from SQS

### File Deleted Function (`file-deleted`)

- **Trigger**: SQS message from EventBridge when an object is deleted from an S3 bucket
- **Purpose**: Removes checksum records for deleted files
- **Key Features**:
  - Removes checksum records from DynamoDB
  - Removes scheduled verification tasks from scheduler table
  - Handles batch processing from SQS

### Checksum Verification Function (`checksum-verification`)

- **Trigger**: DynamoDB TTL expiry events from the scheduler table
- **Purpose**: Verifies file integrity by recalculating checksums
- **Key Features**:
  - Retrieves existing checksum records
  - Downloads files from S3 and recalculates checksums
  - Compares new checksums with stored values
  - Updates checksum records with verification results
  - Reschedules future verification tasks
  - Sends SNS notifications on verification failures

### Checksum Failure Function (`checksum-failure`)

- **Trigger**: DynamoDB stream events when a checksum verification fails
- **Purpose**: Handles checksum verification failures
- **Key Features**:
  - Processes failed checksum verification events
  - Sends detailed failure notifications via SNS
  - Logs failure details for audit purposes
  - Uses email templates for formatted notifications

### Checksum Exporter Function (`checksum-exporter`)

- **Trigger**: Scheduled EventBridge rule
- **Purpose**: Exports DynamoDB checksum table for backup and analysis
- **Key Features**:
  - Exports entire DynamoDB checksum table to S3
  - Creates timestamped exports in DYNAMODB_JSON format
  - Runs on first day of each month at 8 AM UTC

### Checksum Export CSV Report Function (`checksum-export-csv-report`)

- **Trigger**: S3 object creation events for DynamoDB export files
- **Purpose**: Converts DynamoDB exports to CSV format for analysis
- **Key Features**:
  - Processes DynamoDB export files (.json.gz)
  - Converts JSON records to CSV format
  - Uploads structured CSV reports to S3
  - Handles compressed export data

### Inventory Unwrap Function (`inventory-unwrap`)

- **Trigger**: Inventory manifest (S3 object) created notification
- **Purpose**: Unwraps .gz to .csv with headers and uploads stats to S3
- **Key Features**:
  - Extracts inventory data files (.csv.gz) and reuploads as CSV
  - Adds headers to the CSV
  - Parses the inventory to capture stats (storage used and no. files)
  - Uploads stats to S3

### Report Generator Function (`report-generator`)

- **Trigger**: Scheduled EventBridge rule
- **Purpose**: Generates storage analytics reports
- **Key Features**:
  - Downloads inventory stats (generated by inventory-unwrap)
  - Generates HTML reports with storage analytics
  - Uploads reports to managed bucket with timestamps
  - Uses embedded HTML templates for formatting

## Monitoring and Alerting

### CloudWatch Alarms

- **Purpose**: Monitor system health and alert on issues
- **Key Features**:
  - Monitors Lambda function errors and timeouts
  - Monitors DynamoDB capacity consumption and throttling
  - Monitors SQS dead-letter queues for failed messages
  - Tracks checksum verification failures
  - Sends alerts via SNS email notifications

## Data Storage

### DynamoDB Tables

#### Checksum Table (`{stack-name}-checksum-table`)

- **Purpose**: Stores file checksums and verification status
- **Key Structure**:
  - Partition Key: BucketName (String)
  - Sort Key: ObjectKey (String)
- **Attributes**:
  - BucketName: S3 bucket name
  - ObjectKey: S3 object key
  - Checksum: Calculated MD5 file checksum
  - LastChecksumDate: Timestamp of last verification
  - LastChecksumMessage: Status message from verification
  - LastChecksumSuccess: Boolean indicating verification success
  - NextChecksumDate: Scheduled next verification timestamp
- **Features**:
  - DynamoDB Streams enabled (NEW_AND_OLD_IMAGES)
  - Point-in-time recovery enabled
  - Stream triggers checksum-failure function on verification failures

#### Scheduler Table (`{stack-name}-checksum-scheduler-table`)

- **Purpose**: Schedules checksum verification tasks using TTL
- **Key Structure**:
  - Partition Key: BucketName (String)
  - Sort Key: ObjectKey (String)
- **Attributes**:
  - BucketName: S3 bucket name
  - ObjectKey: S3 object key
  - TTL: Expiry timestamp for scheduling verification
- **Features**:
  - TTL enabled on TTL attribute
  - DynamoDB Streams enabled (OLD_IMAGE)
  - Point-in-time recovery enabled
  - TTL expiry triggers checksum-verification function

### S3 Buckets

### Managed Bucket (`{stack-name}-managed`)

- **Purpose**: Stores system data, reports, exports, and audit logs
- **Key Features**:
  - Lifecycle policy for automatic cleanup
  - Versioning enabled with noncurrent version expiration
  - Receives DynamoDB exports under `exports/` prefix
  - Stores CSV reports converted from exports
  - Stores HTML storage reports under `reports/` prefix
  - Audit logs stored under `audit/` prefix
  - Inventory reports stored under `inventory/` prefix

### Bucket Requested Bucket (`{stack-name}-bucket-requested`)

- **Purpose**: Receives bucket creation requests from users
- **Key Features**:
  - Triggers bucket-requested Lambda function on file upload
  - EventBridge notifications enabled
  - Acts as inbox for bucket provisioning requests
  - Supports batch requests (up to 5 buckets per request)

## IAM and Security

- **IAM Roles**: Least privilege access for each Lambda function with specific permissions
  - Bucket Requested Function: S3 bucket creation, policy management, replication setup
  - File Processing Functions: S3 object access, DynamoDB read/write
  - Export Functions: DynamoDB export permissions, S3 write access
  - Monitoring Functions: SNS publish, CloudWatch metrics access
- **IAM Groups**: S3PowerUsers and S3Users with appropriate bucket access permissions
- **Bucket Policies**: Granular access control for S3 buckets with service-specific permissions
- **S3 Replication Role**: Dedicated IAM role for cross-bucket replication
- **Public Access Blocks**: Prevent unintended public access except for designated public buckets
- **EventBridge-SQS Integration**: IAM role for EventBridge to send messages to SQS queues

## Deployment and Configuration

The application is deployed using [Terraform](./terraform/modules/duracloud).
